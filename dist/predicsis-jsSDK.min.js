angular.module("predicsis.jsSDK",["restangular"]).provider("predicsisAPI",function(){var errorHandler=function(response){throw Error(response)},baseURL="https://api.predicsis.com",oauthToken="no-token-defined";this.setBaseUrl=function(url){baseURL=url},this.getBaseUrl=function(){return baseURL},this.setOauthToken=function(token){oauthToken=token},this.getOauthToken=function(){return oauthToken},this.hasOauthToken=function(){return Boolean(void 0===oauthToken)},this.setErrorHandler=function(handler){errorHandler=handler},this.$get=function(Restangular,Datasets,Dictionaries,Jobs,Modalities,Models,OauthTokens,OauthApplications,PreparationRules,Projects,Reports,UserSettings,Sources,Uploads,Users,Variables,jobsHelper,modelHelper,projectsHelper){var self=this;return Restangular.setBaseUrl(this.getBaseUrl()),Restangular.setDefaultHeaders({accept:"application/json",Authorization:"Bearer "+this.getOauthToken()}),Restangular.setErrorInterceptor(function(response){errorHandler(response)}),Restangular.addResponseInterceptor(function(data,operation,what,url,response){if(["getList","post","get","patch"].indexOf(operation)>-1&&204!==response.status){var resourceName=Object.keys(response.data)[0];resourceName&&(data=response.data[resourceName])}return data}),{Datasets:Datasets,Dictionaries:Dictionaries,Jobs:Jobs,Modalities:Modalities,Models:Models,OauthTokens:OauthTokens,OauthApplications:OauthApplications,PreparationRules:PreparationRules,Projects:Projects,Reports:Reports,Sources:Sources,Uploads:Uploads,Users:Users,UserSettings:UserSettings,Variables:Variables,jobsHelper:jobsHelper,modelHelper:modelHelper,projectsHelper:projectsHelper,_restangular:Restangular,setOauthToken:function(token){self.setOauthToken(token),Restangular.setDefaultHeaders({accept:"application/json",Authorization:token})},setErrorHandler:function(handler){self.setErrorHandler(handler)}}}}),angular.module("predicsis.jsSDK").service("Datasets",function($q,Restangular,jobsHelper){"use strict";function dataset(id){return Restangular.one("datasets",id)}function datasets(){return Restangular.all("datasets")}var self=this;this.create=function(params){return jobsHelper.wrapAsyncPromise(datasets().post({dataset:params}))},this.split=function(id,name,filename,sampling){sampling=sampling||70;var learn={parent_dataset_id:id,name:"learned_"+name,data_file:{filename:"learned_"+filename},sampling:sampling},test={parent_dataset_id:id,name:"tested_"+name,data_file:{filename:"tested_"+filename},sampling:-sampling};return $q.all([this.create(learn),this.create(test)])},this.all=function(ids){return void 0===ids?datasets().getList():(ids=ids||[],$q.all(ids.map(function(id){return dataset(id).get()})))},this.get=function(id){return dataset(id).get()},this.getChildren=function(id){return self.get(id).then(function(originalDataset){return self.all(originalDataset.children_dataset_ids)}).then(function(subsets){return subsets.reduce(function(memo,child){return child.sampling>0?memo.train=child:memo.test=child,memo},{})})},this.update=function(id,changes){return changes.separator&&"	"===changes.separator&&(changes.separator="\\t"),jobsHelper.wrapAsyncPromise(dataset(id).patch({dataset:changes}))},this["delete"]=function(id){return dataset(id).remove()}}),angular.module("predicsis.jsSDK").service("Dictionaries",function($q,Restangular,jobsHelper){"use strict";function dictionary(id){return Restangular.one("dictionaries",id)}function dictionaries(){return Restangular.all("dictionaries")}this.createFromDataset=function(dataset){return this.create({name:encodeURI("dictionary_"+dataset.name.toLowerCase()),dataset_id:dataset.id})},this.create=function(params){return jobsHelper.wrapAsyncPromise(dictionaries().post({dictionary:params}))},this.all=function(dictionaryIds){return void 0===dictionaryIds?dictionaries(dictionaryIds).getList():(dictionaryIds=dictionaryIds||[],$q.all(dictionaryIds.map(function(id){return dictionary(id).get()})))},this.get=function(dictionaryId){return dictionary(dictionaryId).get()},this.update=function(dictionaryId,changes){return jobsHelper.wrapAsyncPromise(dictionary(dictionaryId).patch({dictionary:changes}))},this["delete"]=function(dictionaryId){return dictionary(dictionaryId).remove()}}),angular.module("predicsis.jsSDK").service("Jobs",function($q,Restangular){"use strict";function job(id){return Restangular.one("jobs",id)}function jobs(){return Restangular.all("jobs")}this.all=function(jobIds){return void 0===jobIds?jobs(jobIds).getList():(jobIds=jobIds||[],$q.all(jobIds.map(function(id){return job(id).get()})))},this.get=function(jobId){return job(jobId).get()},this["delete"]=function(jobId){return job(jobId).remove()}}),angular.module("predicsis.jsSDK").service("Modalities",function($q,Restangular,jobsHelper){"use strict";function modality(id){return Restangular.one("modalities_sets",id)}function modalities(){return Restangular.all("modalities_sets")}this.create=function(params){return jobsHelper.wrapAsyncPromise(modalities().post({modalities_set:params}))},this.all=function(modalitiesSetIds){return void 0===modalitiesSetIds?modalities().getList():(modalitiesSetIds=modalitiesSetIds||[],$q.all(modalitiesSetIds.map(function(id){return modality(id).get()})))},this.get=function(id){return modality(id).get()},this["delete"]=function(id){return modality(id).remove()}}),angular.module("predicsis.jsSDK").service("Models",function($q,Restangular,jobsHelper){"use strict";function model(id){return Restangular.one("models",id)}function models(){return Restangular.all("models")}var self=this;this.createClassifier=function(preparationRulesSetId){return self.create({type:"classifier",preparation_rules_set_id:preparationRulesSetId})},this.create=function(params){return jobsHelper.wrapAsyncPromise(models().post({model:params}))},this.all=function(modelIds){return void 0===modelIds?models().getList():(modelIds=modelIds||[],$q.all(modelIds.map(function(id){return model(id).get()})))},this.get=function(id){return model(id).get()},this.update=function(id,changes){return jobsHelper.wrapAsyncPromise(model(id).patch({model:changes}))},this["delete"]=function(id){return model(id).remove()}}),angular.module("predicsis.jsSDK").service("OauthApplications",function(Restangular){"use strict";function settings(){return Restangular.all("settings")}function applications(){return settings().all("applications")}this.create=function(name,redirectURI){return applications().post({application:{name:name,redirect_uri:redirectURI}})},this.all=function(){return applications().getList()},this.get=function(appId){return settings().one("applications",appId).get()},this.update=function(appId,changes){return settings().one("applications",appId).patch({application:changes})},this["delete"]=function(appId){return settings().one("applications",appId).remove()}}),angular.module("predicsis.jsSDK").service("OauthTokens",function(Restangular){"use strict";function settings(){return Restangular.all("settings")}function tokens(){return settings().all("tokens")}this.create=function(name){return tokens().post({token:{name:name}})},this.all=function(){return tokens().getList()},this.get=function(tokenId){return settings().one("tokens",tokenId).get()},this["delete"]=function(tokenId){return settings().one("tokens",tokenId).remove()}}),angular.module("predicsis.jsSDK").service("PreparationRules",function($q,Restangular,jobsHelper){"use strict";function preparationRulesSet(id){return Restangular.one("preparation_rules_sets",id)}function preparationRulesSets(){return Restangular.all("preparation_rules_sets")}this.create=function(params){return jobsHelper.wrapAsyncPromise(preparationRulesSets().post({preparation_rules_set:params}))},this.all=function(preparationRulesSetIds){return void 0===preparationRulesSetIds?preparationRulesSets().getList():(preparationRulesSetIds=preparationRulesSetIds||[],$q.all(preparationRulesSetIds.map(function(id){return preparationRulesSet(id).get()})))},this.get=function(id){return preparationRulesSet(id).get()},this.update=function(id,changes){return jobsHelper.wrapAsyncPromise(preparationRulesSet(id).patch({preparation_rules_set:changes}))},this["delete"]=function(id){return preparationRulesSet(id).remove()}}),angular.module("predicsis.jsSDK").service("Projects",function($q,Restangular){"use strict";function project(id){return Restangular.one("projects",id)}function projects(){return Restangular.all("projects")}this.create=function(params){return projects().post({project:params})},this.all=function(projectIds){return void 0===projectIds?projects(projectIds).getList():(projectIds=projectIds||[],$q.all(projectIds.map(function(id){return project(id).get()})))},this.get=function(projectId){return project(projectId).get()},this.update=function(projectId,changes){return project(projectId).patch({project:changes})},this["delete"]=function(projectId){return project(projectId).remove()}}),angular.module("predicsis.jsSDK").service("Reports",function($q,$injector,Restangular,jobsHelper){"use strict";function createClassifierEvaluationReport(project,type){var Datasets=$injector.get("Datasets");return Datasets.getChildren(project.learning_dataset_id).then(function(children){return self.create({type:"classifier_evaluation",dataset_id:children[type].id,classifier_id:project.classifier_id,modalities_set_id:project.modalities_set_id,main_modality:project.main_modality})})}var self=this,report=function(id){return Restangular.one("reports",id)},reports=function(){return Restangular.all("reports")};this.createTrainClassifierEvaluationReport=function(project){return createClassifierEvaluationReport(project,"train")},this.createTestClassifierEvaluationReport=function(project){return createClassifierEvaluationReport(project,"test")},this.createUnivariateSupervisedReport=function(project){return self.create({type:"univariate_supervised",dataset_id:project.learning_dataset_id,dictionary_id:project.dictionary_id,variable_id:project.target_variable_id})},this.create=function(params){return jobsHelper.wrapAsyncPromise(reports().post({report:params}))},this.all=function(reportIds){return void 0===reportIds?reports(reportIds).getList():(reportIds=reportIds||[],$q.all(reportIds.map(function(id){return report(id).get()})))},this.get=function(reportId){return report(reportId).get()},this.update=function(reportId,changes){return jobsHelper.wrapAsyncPromise(report(reportId).patch({report:changes}))},this["delete"]=function(reportId){return report(reportId).remove()}}),angular.module("predicsis.jsSDK").service("Sources",function($q,Restangular,jobsHelper){"use strict";function source(id){return Restangular.one("sources",id)}function sources(){return Restangular.all("sources")}this.create=function(params){return sources().post({source:params})},this.all=function(sourceIds){return void 0===sourceIds?sources().getList():(sourceIds=sourceIds||[],$q.all(sourceIds.map(function(id){return source(id).get()})))},this.get=function(sourceId){return source(sourceId).get()},this.update=function(sourceId,changes){return jobsHelper.wrapAsyncPromise(source(sourceId).patch({source:changes}))},this["delete"]=function(sourceId){return source(sourceId).remove()}}),angular.module("predicsis.jsSDK").service("Uploads",function(Restangular){"use strict";function credentials(storageService){return Restangular.all("sources").one("credentials",storageService)}this.getCredentials=function(storageService){return credentials(storageService).get()},this.sign=function(key){return credentials("s3",key).post({credentials:{key:key}})}}),angular.module("predicsis.jsSDK").service("UserSettings",function(Restangular){"use strict";this.get=function(){return Restangular.one("settings","").get()},this.update=function(changes){return Restangular.all("settings").patch({settings:changes})}}),angular.module("predicsis.jsSDK").service("Users",function($q,Restangular){"use strict";function user(id){return Restangular.one("users",id)}function users(){return Restangular.all("users")}this.create=function(params){return users().post({user:params})},this.resetPassword=function(email,redirectUri){return users().all("password").post({user:{email:email,redirect_uri:redirectUri}})},this.getCurrentUser=function(){return user("me").get()},this.update=function(id,changes){if("current_password"in changes&&"password"in changes){var password={current_password:changes.current_password,password:changes.password};return delete changes.current_password,delete changes.password,Object.keys(changes).length>0?$q.all({profile:user(id).patch({user:changes}),password:users().all("update_password").patch({user:password})}):users().all("update_password").patch({user:password})}return user(id).patch({user:changes})},this["delete"]=function(id){return user(id).remove()}}),angular.module("predicsis.jsSDK").service("Variables",function($q,Restangular){"use strict";function variable(dictionaryId,variableId){return Restangular.one("dictionaries",dictionaryId).one("variables",variableId)}function variables(dictionaryId){return Restangular.one("dictionaries",dictionaryId).all("variables")}this.all=function(dictionaryId,variablesIds){return void 0===variablesIds?variables(dictionaryId,variablesIds).getList():(variablesIds=variablesIds||[],$q.all(variablesIds.map(function(id){return variables(dictionaryId,id).get()})))},this.get=function(dictionaryId,variableId){return variable(dictionaryId,variableId).get()},this.update=function(dictionaryId,variableId,changes){return variable(dictionaryId,variableId).patch({variable:changes})}}),angular.module("predicsis.jsSDK").service("jobsHelper",function($q,Jobs){"use strict";var self=this;self.listen=function(jobId){var deferred=$q.defer(),isRequestPending=!1,requestCounter=0,intervalId=window.setInterval(function(){isRequestPending||(isRequestPending=!0,requestCounter++,Jobs.get(jobId).then(function(job){if("failed"===job.status){clearInterval(intervalId);var error=new Error(job.error.message);error.status=job.error.status,deferred.reject(error)}else if("completed"===job.status)clearInterval(intervalId),deferred.resolve(jobId);else{var timeout=60;20>requestCounter&&(timeout=3),window.setTimeout(function(){isRequestPending=!1},1e3*timeout)}}).then(null,function(error){clearInterval(intervalId),deferred.reject(error)}))},1e3);return deferred.promise},self.wrapAsyncPromise=function(promise){return promise.then(function(asyncResult){var jobId=(asyncResult.job_ids||[]).slice(-1)[0];return self.listen(jobId).then(function(){return asyncResult})})}}),angular.module("predicsis.jsSDK").service("modelHelper",function($injector){"use strict";this.learn=function(project){var Datasets=$injector.get("Datasets"),Models=$injector.get("Models"),Reports=$injector.get("Reports"),Projects=$injector.get("Projects"),PreparationRules=$injector.get("PreparationRules"),$q=$injector.get("$q"),results={};return Datasets.getChildren(project.learning_dataset_id).then(function(children){if(!children.train)throw"Invalid project on POST preparation_rules, no valid train dataset found";return PreparationRules.create({variable_id:project.target_variable_id,dataset_id:children.train.id})}).then(function(preparationRulesRet){return results.preparation_rules_set=preparationRulesRet,Models.createClassifier(preparationRulesRet.id)}).then(function(classifier){return results.classifier=classifier,project.classifier_id=classifier.id,$q.all([Reports.createTrainClassifierEvaluationReport(project),Reports.createTestClassifierEvaluationReport(project),Reports.createUnivariateSupervisedReport(project)])}).then(function(reports){var reportIds=reports.map(function(report){return report.id});return Projects.update(project.id,{preparation_rules_set_id:results.preparation_rules_set.id,classifier_id:results.classifier.id,report_ids:reportIds})}).then(function(){return results.classifier})},this.fetchRelatedData=function(modelId){var Models=$injector.get("Models"),Datasets=$injector.get("Datasets"),PreparationRules=$injector.get("PreparationRules");return Models.get(modelId).then(function(model){return PreparationRules.get(model.preparation_rules_set_id).then(function(preparationRules){return model.preparationRules=preparationRules,Datasets.get(preparationRules.dataset_id).then(function(dataset){return model.preparationRules.dataset=dataset,model})})})}}),angular.module("predicsis.jsSDK").service("projectsHelper",function($injector){"use strict";var Projects=$injector.get("Projects");this.isModelDone=function(project){return Boolean(project.classifier_id)},this.isDictionaryVerified=function(project){return Boolean(project.is_dictionary_verified)},this.getCurrentState=function(project){return project.scoreset_ids&&project.scoreset_ids.length?{view:"project.deploy-overview",properties:{projectId:project.id}}:project.scoring_dataset_ids&&project.scoring_dataset_ids.length?{view:"project.format-score",properties:{projectId:project.id,datasetId:project.scoring_dataset_ids.slice(-1)[0]}}:project.classifier_id?{view:"project.model_overview",properties:{projectId:project.id,modelId:project.classifier_id}}:project.learning_dataset_id&&project.dictionary_id?{view:"project.learn-config",properties:{projectId:project.id,datasetId:project.learning_dataset_id,dictionaryId:project.dictionary_id}}:{view:"project.select_learned_dataset",properties:{projectId:project.id}}},this.getCurrentStep=function(currentView){return"project.deploy-overview"===currentView?"deploy-overview":["project.model_overview","project.variables-inspection"].indexOf(currentView)>=0?"model-overview":["project.create","project.select_learned_dataset","project.format","project.learn-config","project.learn"].indexOf(currentView)>=0?"model-creation":"deploy"},this.getStateFromStep=function(project,toStep){return"model-overview"===toStep&&project.classifier_id?{view:"project.model_overview",properties:{projectId:project.id,modelId:project.classifier_id}}:"deploy"===toStep&&project.scoring_dataset_ids.length>0?{view:"project.select_scored_dataset",properties:{projectId:project.id}}:"deploy-overview"===toStep&&project.scoreset_ids.length>0?{view:"project.deploy-overview",properties:{projectId:project.id}}:!1},this.addLearningDataset=function(project,datasetId){return Projects.update(project.id,{learning_dataset_id:datasetId})},this.addScoringDataset=function(project,datasetId){var update={};return update.scoring_dataset_ids=project.scoring_dataset_ids||[],update.scoring_dataset_ids.push(datasetId),Projects.update(project.id,update)},this.addScoreset=function(project,datasetId){var update={};return update.scoreset_ids=project.scoreset_ids||[],update.scoreset_ids.push(datasetId),Projects.update(project.id,update)},this.resetDictionary=function(projectId){return Projects.update(projectId,{dictionary_id:null,is_dictionary_verified:null,target_variable_id:null,main_modality:null})},this.removeDependencies=function(projectId){var Dictionaries=$injector.get("Dictionaries"),Models=$injector.get("Models");return Projects.get(projectId).then(function(project){return null===project.dictionary_id?project:Dictionaries["delete"](project.dictionary_id).then(function(){return project})}).then(function(project){return null===project.classifier_id?project:Models["delete"](project.classifier_id).then(function(){return project},function(err){if(404===err.status)return project;throw err})})}}),angular.module("predicsis.jsSDK").service("s3FileHelper",function($injector){"use strict";var Upload=$injector.get("Uploads"),$q=$injector.get("$q");this.upload=function(file,progressHandler){var deferred=$q.defer();return Upload.getCredentials("s3").then(function(credential){var key=credential.key.replace("${filename}",file.name),form=formFactory({key:key,AWSAccessKeyId:credential.aws_access_key_id,"Content-Type":"multipart/form-data",success_action_status:201,acl:"private",policy:credential.policy,signature:credential.signature},{file:file}),xhr2=new XMLHttpRequest;xhr2.open("POST",credential.s3_endpoint,!0),progressHandler&&xhr2.upload.addEventListener("progress",progressHandler),xhr2.addEventListener("load",function(){201===xhr2.status?deferred.resolve({filename:file.name,key:key}):deferred.reject({status:xhr2.status,err:xhr2.responseText})}),xhr2.addEventListener("error",function(err){deferred.reject(err)}),xhr2.send(form)}),deferred.promise}});
//# sourceMappingURL=predicsis-jsSDK.min.js.map